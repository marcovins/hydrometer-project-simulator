@startuml Sequence_Diagram

title Diagrama de Sequência - Simulação de Hidrômetro

skinparam sequenceMessageAlign center
skinparam backgroundColor #FAFAFA
skinparam participantBackgroundColor #E6F2FF
skinparam participantBorderColor #333333
skinparam actorBackgroundColor #FFE6E6
skinparam actorBorderColor #333333

actor Usuario as U
participant Main as M
participant Simulator as S
participant Hidrometer as H
participant PipeIN as PI
participant PipeOUT as PO
participant Image as I

== Inicialização ==
U -> M : Executa programa
M -> S : new Simulator()
S -> H : new Hidrometer()
S -> I : new Image()
H -> PI : new Pipe(entrada)
H -> PO : new Pipe(saída)

== Ativação ==
M -> S : run()
S -> S : criar threads
activate S

== Thread de Vazão ==
loop Simulação ativa
    S -> PI : calculateFlow(deltaP)
    PI -> PI : Darcy-Weisbach
    PI --> S : vazão calculada
    S -> H : setFlowRate(vazão)
    H -> PO : updateFlow()
    S -> S : sleep(100ms)
end

== Thread de Imagem ==
loop A cada 1m³
    S -> I : generateHidrometerImage()
    I -> H : getVolume()
    I -> H : getFlowRate()
    I -> I : drawPointer()
    I -> I : drawDisplay()
    I -> I : saveImage()
    S -> S : sleep(500ms)
end

== Thread Principal ==
loop Monitoramento
    U -> M : pressiona tecla
    alt tecla == 'q'
        M -> S : stop()
        S -> S : running = false
    else tecla == 's'
        M -> S : getStatus()
        S --> M : volume, vazão, status
        M --> U : exibe informações
    end
end

== Finalização ==
deactivate S
S -> H : destructor
S -> I : destructor
M --> U : Programa encerrado

note over S
  Padrão Observer
  Threads observam estado
  atomicamente
end note

note over H
  Thread Safety
  atomic<bool>, atomic<float>
  para sincronização
end note

note over PI, PO
  Strategy Pattern
  Diferentes estratégias
  para regime laminar/turbulento
end note

@enduml
